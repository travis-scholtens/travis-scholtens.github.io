<!DOCTYPE HTML>
<html>
<head>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <style>
    .list-group {
      max-width: 460px;
      margin: 4rem auto;
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
  <script src="data.js" type="text/javascript"></script>
  <script>
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('/sw.js', {scope: '/'})
    }
    
    const cacheName = 'tps_lineups';
    
    let selectedPlayer = null;
    
    let saved = false;
    
    const selectSub = (division, team, lineup, court, position) => {
      let availableSubs = [];
      Object.keys(rosters).forEach(subDivision => {
        if (subDivision > division && rosters[subDivision][team] !== undefined) {
          availableSubs = availableSubs.concat(rosters[subDivision][team]);
        }
      });
      return availableSubs.sort().map(player => {
        const name = document.createElement('div');
        name.class = 'list-group w-auto';
        name.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + player['name'] +
          '</h6></div></div></a>';
        name.addEventListener('click', () => {
          selectedPlayer = {court: court, position: position, player: {name: player['name'], sub: true}};
          history.back();
        });
        return name;
      });
    };
    
    const selectPlayer = (division, team, lineup, court, position) => {
      const players = rosters[division][team].sort().map(player => {
        const name = document.createElement('div');
        name.class = 'list-group w-auto';
        name.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + player['name'] + (player['rank'] !== undefined ? ' (' + player['rank'] + ')' : '') +
          '</h6></div></div></a>';
        name.addEventListener('click', () => {
          selectedPlayer = {court: court, position: position, player: player};
          history.back();
        });
        return name;
      });
          
      const sub = document.createElement('button');
      sub.class = 'w-100 btn btn-lg btn-primary';
      sub.innerText = 'Sub...'
      sub.addEventListener('click', () => {
        history.pushState({division: division, team: team, lineup: lineup, court: court, position: position, sub: true}, 'Select sub');
        setContent(selectSub(division, team, lineup, court, position));
      });
      
      const other = document.createElement('div');
      const label = document.createElement('span');
      label.innerText = 'Other:';
      other.appendChild(label);
      const value = document.createElement('input');
      value.type = 'text';
      value.addEventListener('change', e => {
        selectedPlayer = {court: court, position: position, player: {name: e.target.value, adhoc: true}};
        history.back();
      });
      other.appendChild(value);
          
      return players.concat([sub, other]);
    };
    
    const concatNotes = (a, b) => {
      const res = {};
      [1,2,3,4,5,6].forEach(court => {
        res[court] = a[court].concat(b[court]);
      });
      return res;
    };
    
    const notes6d = (division, team, lineup) => {
      const fourCourtException = [1,2,3,4].every(court => {
        return [1,2].every(position => {
          return lineup['court'][court][position] === null ||
            lineup['court'][court][position]['sub'] === undefined;
        });
      });
      const notes = {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
      if (!fourCourtException) {
        let firstSub = null;
        [1,2,3,4,5].forEach(court => {
          if (firstSub) {
            ([1,2].forEach(position => {
              if (lineup['court'][court][position] !== null &&
                  !lineup['court'][court][position]['sub']) {
                notes[court].push(
                  'Substitute ' + firstSub['name'] +
                  ' cannot play above rostered player ' +
                  lineup['court'][court][position]['name']);
               }
            });
          } else {
            for (let position = 1; position <= 2; position++) {
              if (lineup['court'][court][position] !== null &&
                  lineup['court'][court][position]['sub']) {
                firstSub = lineup['court'][court][position];
                break;
              }
            }
          }
        });
      }
      return notes;
    };
    
    const notes6g = (division, team, lineup) => {
      return {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
    };
    
    const notes6 = (division, team, lineup) => {
      return concatNotes(notes6d(division, team, lineup), notes6g(division, team, lineup));
    };

    const notes7 = (division, team, lineup) => {
      return {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
    };
    
    const general = (division, team, lineup) => {
      return {1:[], 2:[], 3:[], 4:[], 5:[], 6:[]};
    };
    
    const getNotes = (division, team, lineup) => {
      return concatNotes(notes6(division, team, lineup), concatNotes(notes7(division, team, lineup), general(division, team, lineup)));
    };
    
    const editLineup = (division, team, lineup) => {
      const notes = getNotes(division, team, lineup);
      
      var lines = [1,2,3,4,5,6].map(court => {
        const line = document.createElement('div');
        line.class = 'list-group w-auto';
        line.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div>'
          +
          '</div></div></a>';
        let innerDiv = line;
        while (innerDiv.firstChild) {
          innerDiv = innerDiv.firstChild;
        }
        
        const courtTitle = document.createElement('h6');
        courtTitle.class = 'mb-0';
        courtTitle.innerText = court;
        innerDiv.appendChild(courtTitle);

        [1,2].forEach(position => {
          const player = document.createElement('div');
          player.class = 'mb-0';
          player.addEventListener('click', () => {
            history.pushState({division: division, team: name, lineup: lineup, court: court, position: position}, 'Select player');
            setContent(selectPlayer(division, team, lineup, court, position));
          });
          const playerInfo = lineup['court'][court][position];
          player.innerText = playerInfo ? (playerInfo['name'] + (playerInfo['rank'] !== undefined ? ' (' + playerInfo['rank'] + ')' : '')) : 'Select...';
          innerDiv.appendChild(player);
        });
        
        notes[court].forEach(items => {
          items.forEach(item => {
            const note = document.createElement('div');
            note.class = 'mb-0';
            note.innerText = item['message'];
            innerDiv.appendChild(note);
          });
        });
        
        return line;
      });
      
      const save = document.createElement('button');
      save.class = 'w-100 btn btn-lg btn-primary';
      save.innerText = 'Save'
      save.addEventListener('click', () => {
        let lineups = loadLineups();
        let found = false;
        for (let i = 0; i < lineups.length; i++) {
          if (lineups[i][0] == division && lineups[i][1] == team && lineups[i][2]['date'] == lineup['date']) {
            lineups[i][2] = lineup;
            found = true;
            break;
          }
        }
        if (!found) {
          lineups = lineups.concat([[division, team, lineup]]);
        }
        localStorage.setItem(cacheName, JSON.stringify(lineups));
        saved = true;
        history.back();
      });
      
      const remove = document.createElement('button');
      remove.class = 'w-100 btn btn-lg btn-primary';
      remove.innerText = 'Remove'
      remove.addEventListener('click', () => {
        let lineups = loadLineups();
        for (let i = 0; i < lineups.length; i++) {
          if (lineups[i][0] == division && lineups[i][1] == team && lineups[i][2]['date'] == lineup['date']) {
            lineups.splice(i, 1);
            break;
          }
        }
        localStorage.setItem(cacheName, JSON.stringify(lineups));
        saved = true;
        history.back();
      });
      
      return lines.concat([save, remove]);
    };
    
    const chooseTeam = division => {
      return Object.keys(rosters[division]).sort().map(name => {
        const team = document.createElement('div');
        team.class = 'list-group w-auto';
        team.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + name + 
          '</h6></div></div></a>';
        team.addEventListener('click', () => {
          const newLineup = {
            date: new Date().toJSON(),
            court: {
              1: {1: null, 2: null},
              2: {1: null, 2: null},
              3: {1: null, 2: null},
              4: {1: null, 2: null},
              5: {1: null, 2: null},
              6: {1: null, 2: null}
            }
          };
          history.pushState({division: division, team: name, lineup: newLineup}, 'Edit lineup');
          setContent(editLineup(division, name, newLineup));
        });
        return team;
      });
    };
    
    const chooseDivision = () => {
      return Object.keys(rosters).sort().map(name => {
        const division = document.createElement('div');
        division.class = 'list-group w-auto';
        division.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + name + 
          '</h6></div></div></a>';
        division.addEventListener('click', () => {
          history.pushState({division: name}, 'Choose team');
          setContent(chooseTeam(name));
        });
        return division;
      });
    };
    
    const lineupList = () => {     
      const newLineup = document.createElement('button');
      newLineup.class = 'w-100 btn btn-lg btn-primary';
      newLineup.innerText = 'New...'
      newLineup.addEventListener('click', () => {
        history.pushState({divisions: true}, 'Choose division');
        setContent(chooseDivision());
      });
      
      const lineups = loadLineups();
      
      const savedLineups = lineups.map(lineup_data => {
        const division = lineup_data[0];
        const team = lineup_data[1];
        const lineup = lineup_data[2];
        
        const edit = document.createElement('div');
        edit.class = 'list-group w-auto';
        edit.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + lineup['date'] + ': '
          + division + ', '
          + team +
          '</h6></div></div></a>';
        edit.addEventListener('click', () => {
          history.pushState({division: division, team: team, lineup: lineup}, 'Edit lineup');
          setContent(editLineup(division, team, lineup));
        });
        
        return edit;
      });
      
      return [newLineup].concat(savedLineups);
    };
    
    const setContent = elements => {
      const content = document.getElementById('content');
      while(content.firstChild) {
        content.removeChild(content.firstChild);
      }
      elements.forEach(e => content.appendChild(e));
    };
    
    const loadLineups = () => {
      const lineups = localStorage.getItem(cacheName);
      if (lineups === null) {
        return [];
      }
      return JSON.parse(lineups);
    }
    
    window.addEventListener('popstate', e => {
      const state = e.state;
      if (state !== null) {
        if (state['lineups'] === true) {
          if (saved) {
            saved = false;
          }
          setContent(lineupList());
        } else if (state['divisions'] === true) {
          if (saved) {
            history.back();
          } else {
            setContent(chooseDivision());
          }
        } else if (state['division'] !== undefined) {
          if (state['lineup'] !== undefined) {
            if (state['court'] !== undefined) {
              setContent(selectPlayer(state['division'], state['team'], state['lineup'], state['court'], state['position']));
            } else {
              if (selectedPlayer !== null) {
                state['lineup']['court'][selectedPlayer['court']][selectedPlayer['position']] = selectedPlayer['player'];
                selectedPlayer = null;
              }
              history.replaceState(state, 'Edit lineup');
              setContent(editLineup(state['division'], state['team'], state['lineup']));
            }
          } else {
            if (saved) {
              history.back();
            } else {
              setContent(chooseTeam(state['division']));
            }
          }
        }
      }
    });
    
    window.onload = () => {
      history.pushState({lineups: true}, 'Lineups');
      setContent(lineupList());
    };
  </script>
  <div id="content">
  </div>
</body>
</html>
