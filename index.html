<!DOCTYPE HTML>
<html>
<head>
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <style>
    .list-group {
      max-width: 460px;
      margin: 4rem auto;
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous"></script>
  <script src="data.js" type="text/javascript"></script>
  <script>
    if (navigator.serviceWorker) {
      navigator.serviceWorker.register('/sw.js', {scope: '/'})
    }
    
    const cacheName = 'tps_lineups';
    
    let selectedPlayer = null;
    
    const selectPlayer = (division, team, lineup, court, position) => {
      return rosters[division][team].sort().map(player => {
        const name = document.createElement('div');
        name.class = 'list-group w-auto';
        name.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + player['name'] + 
          '</h6></div></div></a>';
        name.addEventListener('click', () => {
          selectedPlayer = {court: court, position: position, name: player['name']};
          history.back();
        });
        return name;
      });
    };
    
    const editLineup = (division, team, lineup) => {
      return [1,2,3,4,5,6].map(court => {
        const line = document.createElement('div');
        line.class = 'list-group w-auto';
        line.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div>'
          +
          '</div></div></a>';
        let innerDiv = line;
        while (innerDiv.firstChild) {
          innerDiv = innerDiv.firstChild;
        }
        
        const courtTitle = document.createElement('h6');
        courtTitle.class = 'mb-0';
        courtTitle.innerText = court;
        innerDiv.appendChild(courtTitle);

        [1,2].forEach(position => {
          const player = document.createElement('div');
          player.class = 'mb-0';
          player.addEventListener('click', () => {
            history.pushState({division: division, team: name, lineup: lineup, court: court, position: position}, 'Select player');
            setContent(selectPlayer(division, team, lineup, court, position));
          });
          player.innerText = lineup['court'][court][position] || 'Select...';
          innerDiv.appendChild(player);
        });
        return line;
      });
    };
    
    const chooseTeam = division => {
      return Object.keys(rosters[division]).sort().map(name => {
        const team = document.createElement('div');
        team.class = 'list-group w-auto';
        team.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + name + 
          '</h6></div></div></a>';
        team.addEventListener('click', () => {
          const newLineup = {
            date: new Date().toJSON(),
            court: {
              1: {1: null, 2: null},
              2: {1: null, 2: null},
              3: {1: null, 2: null},
              4: {1: null, 2: null},
              5: {1: null, 2: null},
              6: {1: null, 2: null}
            }
          };
          history.pushState({division: division, team: name, lineup: newLineup}, 'Edit lineup');
          setContent(editLineup(division, name, newLineup));
        });
        return team;
      });
    };
    
    const chooseDivision = () => {
      return Object.keys(rosters).sort().map(name => {
        const division = document.createElement('div');
        division.class = 'list-group w-auto';
        division.innerHTML =
          '<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3"><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">'
          + name + 
          '</h6></div></div></a>';
        division.addEventListener('click', () => {
          history.pushState({division: name}, 'Choose team');
          setContent(chooseTeam(name));
        });
        return division;
      });
    };
    
    const lineupList = () => {     
      const newLineup = document.createElement('button');
      newLineup.class = 'w-100 btn btn-lg btn-primary';
      newLineup.innerText = 'New...'
      newLineup.addEventListener('click', () => {
        history.pushState({divisions: true}, 'Choose division');
        setContent(chooseDivision());
      });
      
      const lineups = loadLineups();
      
      return [newLineup];
    };
    
    const setContent = elements => {
      const content = document.getElementById('content');
      while(content.firstChild) {
        content.removeChild(content.firstChild);
      }
      elements.forEach(e => content.appendChild(e));
    };
    
    const loadLineups = () => {
      let lineups = localStorage.getItem(cacheName);
      if (lineups === null) {
        lineups = [];
      }
      return lineups;
    }
    
    window.addEventListener('popstate', e => {
      const state = e.state;
      if (state !== null) {
        if (state['lineups'] === true) {
          setContent(lineupList());
        } else if (state['divisions'] === true) {
          setContent(chooseDivision());
        } else if (state['division'] !== undefined) {
          if (state['lineup'] !== undefined) {
            if (state['court'] !== undefined) {
              setContent(selectPlayer(state['division'], state['team'], state['lineup'], state['court'], state['position']));
            } else {
              if (selectedPlayer !== null) {
                state['lineup']['court'][selectedPlayer['court']][selectedPlayer['position']] = selectedPlayer['name'];
                selectedPlayer = null;
              }
              history.replaceState(state, 'Edit lineup');
              setContent(editLineup(state['division'], state['team'], lineup));
            }
          } else {
            setContent(chooseTeams(state['division']));
          }
        }
      }
    });
    
    window.onload = () => {
      history.pushState({lineups: true}, 'Lineups');
      setContent(lineupList());
    };
  </script>
  <div id="content">
  </div>
</body>
</html>
